<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Now that we have learned about arenas and allocators, we can get our hands dirty with an implementation of an arena.
Best Fit Arena You see, for the last couple of months, I&amp;rsquo;ve been updating RiftCore with new features. RiftCore is a cross-platform framework I use for C++ projects, and it lacked some memory management.
So the time came to design a general-purpose arena!
This article will describe the design and implementation of a Best Fit Arena."><meta name=keywords content="muitxer,homepage,blog,portfolio,unreal engine,C++,Rust,piperift"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://muit.xyz/posts/memory-implementing-a-general-arena/><title>Implementing a general-use arena :: Miguel Fernandez Arce</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.css><meta itemprop=name content="Implementing a general-use arena"><meta itemprop=description content="Now that we have learned about arenas and allocators, we can get our hands dirty with an implementation of an arena.
Best Fit Arena You see, for the last couple of months, I&rsquo;ve been updating RiftCore with new features. RiftCore is a cross-platform framework I use for C++ projects, and it lacked some memory management.
So the time came to design a general-purpose arena!
This article will describe the design and implementation of a Best Fit Arena."><meta itemprop=datePublished content="2022-02-03T00:00:00+00:00"><meta itemprop=dateModified content="2022-02-03T00:00:00+00:00"><meta itemprop=wordCount content="445"><meta itemprop=image content="https://muit.xyz"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://muit.xyz"><meta name=twitter:title content="Implementing a general-use arena"><meta name=twitter:description content="Now that we have learned about arenas and allocators, we can get our hands dirty with an implementation of an arena.
Best Fit Arena You see, for the last couple of months, I&rsquo;ve been updating RiftCore with new features. RiftCore is a cross-platform framework I use for C++ projects, and it lacked some memory management.
So the time came to design a general-purpose arena!
This article will describe the design and implementation of a Best Fit Arena."><meta property="og:title" content="Implementing a general-use arena"><meta property="og:description" content="Now that we have learned about arenas and allocators, we can get our hands dirty with an implementation of an arena.
Best Fit Arena You see, for the last couple of months, I&rsquo;ve been updating RiftCore with new features. RiftCore is a cross-platform framework I use for C++ projects, and it lacked some memory management.
So the time came to design a general-purpose arena!
This article will describe the design and implementation of a Best Fit Arena."><meta property="og:type" content="article"><meta property="og:url" content="https://muit.xyz/posts/memory-implementing-a-general-arena/"><meta property="og:image" content="https://muit.xyz"><meta property="article:section" content="Posts"><meta property="article:published_time" content="2022-02-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-03T00:00:00+00:00"><meta property="og:see_also" content="https://muit.xyz/posts/memory-introduction-to-allocators-and-arenas/"><meta property="article:published_time" content="2022-02-03 00:00:00 +0000 UTC"><script src=https://identity.netlify.com/v1/netlify-identity-widget.js></script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>Miguel Fernandez Arce</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/pages/about>About</a></li><li><a href=/posts>Posts</a></li><li><a href=https://github.com/muit>GitHub</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://muit.xyz/posts/memory-implementing-a-general-arena/>Implementing a general-use arena</a></h2><figure class=post-cover><img src=https://muit.xyz/Assets/Img/Covers/storage.png alt="Implementing a general-use arena"></figure><div class=post-content><p>Now that we have learned about
<a href=/posts/memory-introduction-to-allocators-and-arenas/>arenas and allocators</a>, we can get our hands dirty with an implementation of an arena.</p><h2 id=best-fit-arena>Best Fit Arena</h2><p>You see, for the last couple of months, I&rsquo;ve been updating
<a href=https://github.com/PipeRift/rift-core>RiftCore</a> with new features.
<strong>RiftCore</strong> is a cross-platform framework I use for C++ projects, and it lacked some memory management.</p><p>So the time came to design a general-purpose arena!</p><p>This article will describe the design and implementation of a <strong>Best Fit Arena</strong>.
Feel free to come up with a better name though (and put it in the comments below!)</p><h2 id=general-purpose>General-purpose?</h2><p>A general-purpose allocator (or arena) must be able to work on all scenarios with out any big limitation.
As such, it has to be able to:</p><ul><li><strong>Allocate</strong> in any order and any size</li><li><strong>Deallocate</strong> in any order</li><li>Use (and reuse) all space available</li><li>Minimize fragmentation</li></ul><p>In RiftCore, Arenas always carry the <code>size</code> of the pointer in their <code>Free()</code> function.
This opens the door to some optimizations, but, don&rsquo;t worry, the BestFitArena can be adapted to avoid this pattern.</p><h2 id=implementation>Implementation</h2><p>A <strong>BestFitArena</strong> works by <strong>tracking all unused spaces</strong>, called free slots.
<img src=/Assets/Img/best-fit-arena-slot-ids.png alt=BestFitArena></p><p>Let&rsquo;s go through what we see in this picture:</p><ul><li>Like most allocators, we have one or multiple memory blocks of pre-allocated memory.</li><li>We also keep a list of <code>FreeSlots</code>, sorted by size. Bigger first.</li><li>We don&rsquo;t track allocations in any way. No headers, no offsets and no sizes.</li></ul><p><img src=/Assets/Img/best-fit-arena-slot-ptrs.png alt="BestFitArena Slot Pointers">
Seen in more detail, each slot points to the start of its memory and its size.</p><p>This algorithm has <strong>zero overhead</strong> when fragmentation is low. The less fragmentation, the more performant it is.
However, it is also designed to minimize it, and, as you will see later, even in an scenario with a lot of fragmentation, performance is still excellent.</p><h3 id=allocation>Allocation</h3><p><strong>Allocation</strong> will always pick the smallest free slot possible and extract the pointer from it.
Then, this slot is reduced removing the used space from it.
<img src=/Assets/Img/best-fit-arena-allocation.png alt="BestFitArena Allocate"></p><h4 id=find-smallest-slot>Find Smallest Slot</h4><p>Before anything else, we check if the arena is marked as pending sort.
This is an optimization that prevents unnecessary sorts on consequent Free calls.
But we also perform shrink on the slots if necessary.</p><p>Once we know all slots are sorted, we perform a
<a href=https://www.geeksforgeeks.org/binary-search/>binary search</a> by size.
The binary search will provide a complexity of O(logN).</p><h3 id=free>Free</h3><p><strong>Free</strong> expands the free slots that &ldquo;touch&rdquo; the freed memory, absorb it and growing the slot.</p><p>We know of the size of the allocation because it is contained on the free slots list which we check anyway.
<img src=/Assets/Img/best-fit-arena-free.png alt="BestFitArena Free"></p><br><p><em>PS</em>: This is a post I never published when I wrote it. So some details might be missing but feel free to ask any questions :)</p></div></article><hr><div class=post-info></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2023</span>
<span><a href=https://github.com/muit rel=noopener>Miguel Fernandez Arce</a></span>
<span><a href=https://muit.xyz/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span><a href=https://github.com/piperift>Piperift</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.73c7c714cf43f7ae79f853c64ef05a1697c65bea136f1f8b34951a913a9c586631efbfd5bd0f3b9dd71d0f79839fa6983fb87b4d4a8d209e3c174c41c0367f7b.js integrity="sha512-c8fHFM9D9655+FPGTvBaFpfGW+oTbx+LNJUakTqcWGYx77/VvQ87ndcdD3mDn6aYP7h7TUqNIJ48F0xBwDZ/ew=="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D66MJWXCKK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D66MJWXCKK",{anonymize_ip:!1})}</script><script>window.netlifyIdentity&&window.netlifyIdentity.on("init",e=>{e||window.netlifyIdentity.on("login",()=>{document.location.href="/admin/"})})</script></body></html>